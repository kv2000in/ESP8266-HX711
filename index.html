
<!DOCTYPE html>
<html>
	<head>
		<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable=0">
			<title>Transducer Height Project</title>
			<style>
				"body { background-color: #808080; font-family: Arial, Helvetica, Sans-Serif; Color: #000000; }"
				</style>
			<style>
				.ledon {
					align-items: flex-start;
					text-align: center;
					cursor: default;
					color: buttontext;
					background-color: buttonface;
					box-sizing: border-box;
					padding: 2px 6px 3px;
					border-width: 2px;
					border-style: outset;
					border-color: buttonface;
					border-image: initial;
					text-rendering: auto;
					color: initial;
					letter-spacing: normal;
					word-spacing: normal;
					text-transform: none;
					text-indent: 0px;
					text-shadow: none;
					display: inline-block;
					text-align: start;
					margin: 0em;
					font: 11px system-ui;
					
				}
			
			.ledoff {
				background-color: #1ded4d;
				
			}
			</style>
			<script>
				var websock;
				var boolClientactive;
				var boolHasZeroBeenDone = false;
				
				function start() {
					websock = new WebSocket('ws://' + window.location.hostname + '/ws');
                    websock.binaryType = "arraybuffer"; //need to do this when dealing with binary data.
					websock.onopen = function(evt) { console.log('websock open');
						
						
						
					};
					websock.onclose = function(evt) { console.log('websock close'); };
					websock.onerror = function(evt) { console.log(evt); };
					websock.onmessage = function(evt) {
						console.log(evt);
                           if(evt.data instanceof ArrayBuffer) {
                                // binary frame
                    //const view = new DataView(evt.data);
                    //console.log(view.getInt32(0));
                    
                        handleserverbinarydata(evt.data);
                           } else {
                    // text frame
                        console.log(evt.data);
                    }

					};
					
					
				}
			

			function doSend(message)
			{
				console.log("sent: " + message + '\n');
				/* writeToScreen("sent: " + message + '\n'); */
				websock.send(message);
			}
			function fnButton(com){
				
				doSend("COMMAND-"+com);
				
			};
			function download(file){
				
				
			}
			function zero(){
				if (boolClientactive){
					fnButton('ZERO');
					boolHasZeroBeenDone = true; 
				}
				else {
					alert("No client data - ?Client not connected"); 
				}
			}
                
            function handleserverbinarydata(serverbinarydata){
                //16 bytes of data = 6 for mac + 8 for data(really just 6 for data - 4 for float and 2 for int+2 extra) + 2 extra
                var mybinarydataarray= new Uint8Array(serverbinarydata);
                var mysendermacaddress = mybinarydataarray.slice(0,6);
                var myscalefloatvaluebytes = serverbinarydata.slice(6,10); 
                var mybatteryvoltagebytes = serverbinarydata.slice(10,12);
                var myfloatview = new DataView(myscalefloatvaluebytes);
                var myintview = new DataView(mybatteryvoltagebytes);
                var myscalefloatvalue = myfloatview.getFloat32(0,true); // Signed 32 bit float, little endian. https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView/getFloat32
                var mybatteryvoltage = myintview.getInt16(0,true);
                console.log("Data from MAC Address :" + buf2hex(mysendermacaddress) + " Reading = "+myscalefloatvalue+ " Battery = "+mybatteryvoltage);
                
                
                
            }
			//https://stackoverflow.com/questions/40031688/javascript-arraybuffer-to-hex
                
            function buf2hex(buffer) { // buffer is an ArrayBuffer
  return [...new Uint8Array(buffer)]
      .map(x => x.toString(16).padStart(2, '0'))
      .join('');
}
                
                
                
			function startsave()
			{
				if(boolHasZeroBeenDone){
					var decision = confirm("This will overwrite previous data.\n Press OK to proceed, Cancel to abort and Download data");
					if (decision){
						
						fnButton('STARTSAVE');
						/*Disable start save button and enable stop save button
						 Ideally - server should send whether it is currently saving data or not
						 */
						document.getElementById("btSTARTSAVE").disabled=true;
						document.getElementById("btZERO").disabled=true;
						document.getElementById("btSTOPSAVE").disabled=false;
					} else {
						/*user selected cancel - let's redirect user to download the data*/
						
					}
				} else { alert("Set Zero Before Saving")}
			}
			function stopsave(){
				
				fnButton('STOPSAVE');
				document.getElementById("btSTARTSAVE").disabled=false;
				document.getElementById("btZERO").disabled=false;
				document.getElementById("btSTOPSAVE").disabled=true;
			}
			function sendTimestamp(){
				
				/*Send timestamp in milliseconds when connected */
				var d = new Date();
				var n = (d.getTime()/1000);
				doSend("TIME-"+n);
			}
			</script>
	</head>
	<body onpageshow="javascript:start();">
		<!--
Server keeps the calibration data (based on MAC addresses)
Server keeps track of raw values at the time of Tare
Server returns data as 


-->
        
		<div><b>Digital Scale Server</b></div> 
		<label>Available Scales</label><list id = "listofsensornodes">
        
        <button>Assign</button>
        <button>Zero</button>
        <button>Plot</button>
        <Label>Value since zero</Label> <input>
        </list>
		<strong><tspan  id="tspanDistance1">0</tspan> <text> &nbsp;(cm)</text>
		</strong> <button class = "ledon" id ="serverblink"></button>
		<div><b>Height of Client</b></div>
		
		<strong><tspan  id="tspanDistance2">0</tspan> <text> &nbsp;(cm)</text>
		</strong> <button class = "ledon" id ="clientblink"></button> 
		<br>
		<button id = "btZERO" onclick="zero();">SET ZERO</button>
		<button id = "btSTARTSAVE" onclick="startsave();">Start Save</button>
		<button id = "btSTOPSAVE" onclick="stopsave();">Stop Save</button>
		<br><br><br>
		<a href="/Data.txt">Download Data</a>
		<br><br>
		<a href="/Zero.txt">Download Zero File</a>
		<br><br>
		<button id = "btCLOSEWS" onclick="websock.close();">Close Websocket</button>
		
	</body>
	
</html>
